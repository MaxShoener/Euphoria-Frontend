<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Euphoria</title>
  <style>
    :root{
      --bg:#0f0f10; --panel:#1b1b1b; --accent:#2a9d8f; --muted:#9aa0a6; --btn:#2c2c2c;
    }
    *{box-sizing:border-box}
    body{
      margin:0; height:100vh; display:flex; flex-direction:column;
      font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
      background:linear-gradient(180deg,#0b0b0c,#0f1112);
      color:#fff;
    }
    header{
      display:flex; gap:8px; align-items:center; padding:10px;
      background:var(--panel); box-shadow:0 1px 0 rgba(255,255,255,0.02);
    }
    .nav-btn{
      background:var(--btn); border:none; color:#fff; padding:8px 10px; border-radius:6px; cursor:pointer;
      font-size:16px;
    }
    .nav-btn:hover{filter:brightness(1.1)}
    #url{
      flex:1; padding:10px 12px; border-radius:8px; border:none; outline:none;
      background:#121212; color:#fff; font-size:15px;
    }
    #go{background:var(--accent); border:none; padding:8px 14px; border-radius:8px; color:#fff; cursor:pointer}
    #go:hover{filter:brightness(1.05)}
    iframe{
      flex:1; border:none; width:100%; background:#000;
      /* optional: ensure the iframe takes the full viewport height minus header */
      min-height:0;
    }
    .status{
      padding:8px 12px; color:var(--muted); font-size:13px;
    }
  </style>
</head>
<body>
  <header>
    <button id="home" class="nav-btn">üè†</button>
    <button id="back" class="nav-btn">‚óÄ</button>
    <button id="forward" class="nav-btn">‚ñ∂</button>
    <button id="reload" class="nav-btn">‚ü≥</button>
    <input id="url" type="text" placeholder="Search or type URL (e.g. chess.com)" />
    <button id="go">Go</button>
  </header>

  <div class="status" id="status">Initializing‚Ä¶</div>
  <iframe id="browser" src=""></iframe>

  <script>
    const BACKEND_BASE = "https://wisp-server-w7nx.onrender.com";
    const BROWSE_ENDPOINT = BACKEND_BASE + "/browse?url=";
    const PING_ENDPOINT = BACKEND_BASE + "/ping";
    const HOME = "https://www.google.com";

    const iframe = document.getElementById("browser");
    const urlInput = document.getElementById("url");
    const status = document.getElementById("status");

    const backBtn = document.getElementById("back");
    const forwardBtn = document.getElementById("forward");
    const reloadBtn = document.getElementById("reload");
    const homeBtn = document.getElementById("home");
    const goBtn = document.getElementById("go");

    let historyStack = [];
    let currentIndex = -1;

    function setStatus(txt) { status.innerText = txt; }

    // Wake backend once on load
    async function wakeBackend() {
      setStatus("Waking backend...");
      try {
        const r = await fetch(PING_ENDPOINT, { mode: "cors", credentials: "include" });
        if (r.ok) setStatus("Backend ready");
        else setStatus("Backend ping returned " + r.status);
      } catch (e) {
        setStatus("Backend unreachable (will still attempt on go)");
      }
    }

    wakeBackend();

    function normalizeUrl(u) {
      if (!u) return u;
      if (!/^https?:\/\//i.test(u)) {
        return "https://www.google.com/search?q=" + encodeURIComponent(u);
      }
      return u;
    }

    function pushHistory(url) {
      // cut forward history
      if (currentIndex < historyStack.length - 1) {
        historyStack = historyStack.slice(0, currentIndex + 1);
      }
      historyStack.push(url);
      currentIndex = historyStack.length - 1;
      updateNavButtons();
    }

    function updateNavButtons() {
      backBtn.disabled = currentIndex <= 0;
      forwardBtn.disabled = currentIndex >= historyStack.length - 1;
      reloadBtn.disabled = currentIndex < 0;
    }

    function navigateTo(raw) {
      const url = normalizeUrl(raw);
      if (!url) return;
      iframe.src = BROWSE_ENDPOINT + encodeURIComponent(url);
      pushHistory(url);
      urlInput.value = raw;
      setStatus("Loading " + url);
    }

    goBtn.addEventListener("click", () => navigateTo(urlInput.value.trim()));
    urlInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") navigateTo(urlInput.value.trim());
    });

    backBtn.addEventListener("click", () => {
      if (currentIndex > 0) {
        currentIndex--;
        const u = historyStack[currentIndex];
        iframe.src = BROWSE_ENDPOINT + encodeURIComponent(u);
        urlInput.value = u;
        updateNavButtons();
      }
    });

    forwardBtn.addEventListener("click", () => {
      if (currentIndex < historyStack.length - 1) {
        currentIndex++;
        const u = historyStack[currentIndex];
        iframe.src = BROWSE_ENDPOINT + encodeURIComponent(u);
        urlInput.value = u;
        updateNavButtons();
      }
    });

    reloadBtn.addEventListener("click", () => {
      if (currentIndex >= 0) {
        const u = historyStack[currentIndex];
        iframe.src = BROWSE_ENDPOINT + encodeURIComponent(u);
        setStatus("Reloading...");
      }
    });

    homeBtn.addEventListener("click", () => navigateTo(HOME));

    // iframe message to detect when loaded (best-effort)
    iframe.addEventListener("load", () => {
      setStatus("Loaded");
    });

    // Start at home
    navigateTo(HOME);
  </script>
</body>
</html>
